<!DOCTYPE html>
<html lang="id">
<head>
<link rel="icon" href="/favicon-invite.png" type="image/png">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dinner Invitation</title>
<style>
:root{
  --gold:#d4af6a;
  --dark:#0b0b0b;
  --white:#f5f5f5;
}

/* ================= GLOBAL ================= */
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:"Georgia",serif;
  background:var(--dark);
  color:var(--white);
  overflow-x:hidden;
  scroll-snap-type:y mandatory;
}

/* ================= PASSWORD OVERLAY ================= */
#lock{
  position:fixed; inset:0;
  background:radial-gradient(circle at top,#1a1a1a,#000);
  display:flex; justify-content:center; align-items:center;
  z-index:999; transition:opacity 1.2s ease,visibility 1.2s;
}
#lock.hidden{opacity:0;visibility:hidden}
.lock-card{
  background:rgba(20,20,20,.7);
  border:1px solid rgba(212,175,106,.3);
  border-radius:18px; padding:40px 32px;
  text-align:center; backdrop-filter:blur(12px);
  box-shadow:0 30px 80px rgba(0,0,0,.7);
}
.lock-card h2{color:var(--gold);letter-spacing:2px;margin-bottom:18px}
.lock-card input{
  background:#000;border:1px solid var(--gold);
  color:#fff;padding:12px;width:100%;margin-bottom:14px;
  border-radius:8px;text-align:center;
}
.lock-card button{
  background:var(--gold);color:#000;border:none;
  padding:12px 26px;border-radius:30px;
  cursor:pointer;letter-spacing:1px;
}

/* ================= MUSIC ================= */
.music-control{
  position:fixed;top:20px;right:20px;width:54px;height:54px;
  border-radius:50%;display:flex;align-items:center;justify-content:center;
  background:rgba(20,20,20,.55);backdrop-filter:blur(14px);
  border:1px solid rgba(212,175,106,.45);
  color:var(--gold);font-size:18px;cursor:pointer;z-index:300;
  box-shadow:0 10px 35px rgba(0,0,0,.45);
  transition:.35s cubic-bezier(.22,1,.36,1);
}

/* ================= PAGE & CARD ================= */
.page{
  min-height:100vh;
  scroll-snap-align:start;
  display:flex; justify-content:center; align-items:center;
  padding:48px 18px; opacity:0;
  transform:translateY(50px) scale(.96);
  transition:opacity 1.4s ease,transform 1.4s cubic-bezier(.22,1,.36,1);
}
.page.show{opacity:1;transform:none}

.card{
  max-width:760px;width:100%;
  background:rgba(20,20,20,.65);
  border:1px solid rgba(212,175,106,.25);
  border-radius:18px;padding:48px 32px;
  backdrop-filter:blur(10px);
  box-shadow:0 30px 80px rgba(0,0,0,.6);
  text-align:center;position:relative;
}
h1,h2{color:var(--gold);font-weight:500;letter-spacing:2px;margin-bottom:22px}
.divider{width:60px;height:1px;background:var(--gold);margin:22px auto;opacity:.6}
p{font-size:15px;line-height:1.8;opacity:.9}

/* ================= ITINERARY ================= */
.itinerary-item{display:flex;justify-content:space-between;margin:26px 0;opacity:0;transform:translateY(20px);transition:all .9s ease; border-bottom: 1px solid rgba(212,175,106,0.1); padding-bottom: 5px;}
.itinerary-item.show{opacity:1;transform:none}
.itinerary-time{color:var(--gold);font-size:13px; font-weight: bold;}
.itinerary-text{text-align:right;font-size:14px}

/* ================= MENU ================= */
.menu-course{margin:26px 0;opacity:0;transform:translateY(20px);transition:all .9s ease;text-align:center}
.menu-course.show{opacity:1;transform:none}
.course-title{display:block;color:var(--gold);letter-spacing:2px;font-size:13px;margin-bottom:6px}
.course-desc{font-size:14px;opacity:.85;line-height:1.6}

/* ================= MOMENTS (WEB: 3 MENDATAR) ================= */
#moments-section{display:none;}
.moment-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:24px}
.moment{
  aspect-ratio:1/1; background:rgba(255,255,255,.05);border-radius:10px;
  overflow:hidden; opacity:0;transform:scale(.95);transition:all .6s ease;
}
.moment img{width:100%;height:100%;object-fit:cover;}
.moment.show{opacity:1;transform:scale(1)}

/* ================= MEMORY (VIDEO) ================= */
#video-section{display:none;}
.video-wrapper{
  width:100%; max-width:300px; margin:20px auto;
  border:2px solid var(--gold); border-radius:15px; overflow:hidden;
}
video{width:100%; display:block;}

/* ================= UTILS ================= */
.map-btn{display:inline-block;margin-top:18px;padding:10px 24px;border-radius:30px;border:1px solid var(--gold);color:var(--gold);text-decoration:none;letter-spacing:1px;transition:.3s;cursor:pointer;background:transparent; font-size: 13px;}
.map-btn:hover{background:var(--gold);color:#000}

.heart{width:60px;height:60px;margin:28px auto;background:var(--gold);transform:rotate(45deg);cursor:pointer;position:relative;transition:transform .3s}
.heart::before,.heart::after{content:'';position:absolute;width:60px;height:60px;background:var(--gold);border-radius:50%}
.heart::before{top:-30px;left:0}
.heart::after{left:-30px;top:0}

.particles{position:fixed;inset:0;z-index:-1;overflow:hidden}
.particles span{position:absolute;width:3px;height:3px;background:var(--gold);border-radius:50%;opacity:.22;animation:float linear infinite}
@keyframes float{0%{transform:translateY(110vh)}100%{transform:translateY(-10vh)}}
</style>
</head>
<body>

<audio id="bgmMain" loop preload="auto"><source src="bgm-main.mp3" type="audio/mpeg"></audio>
<audio id="bgmMoments" loop preload="auto"><source src="bgm-moments.mp3" type="audio/mpeg"></audio>
<div class="music-control" onclick="toggleMusic()"><span id="musicIcon">‚ùö‚ùö</span></div>

<div id="lock">
  <div class="lock-card">
    <h2>Helen Afriani</h2>
    <h2>Invitation</h2><br>
    <p>Enter the password to continue</p><br>
    <input type="password" id="pwd" placeholder="Password">
    <button onclick="unlock()">OPEN</button>
  </div>
</div>

<div class="particles">
  <span style="left:15%;animation-duration:45s"></span>
  <span style="left:50%;animation-duration:40s"></span>
  <span style="left:85%;animation-duration:55s"></span>
</div>

<section class="page hero">
  <div class="card">
    <h1>Christmas Dinner</h1>
    <div class="divider"></div>
    <p id="typing"></p>
    <div id="countdown" style="margin-top:15px; color:var(--gold); letter-spacing:2px;"></div>
  </div>
</section>

<section class="page note">
  <div class="card">
    <h2>A Note Before the Event</h2>
    <div class="divider"></div>
    <p>Before the event begins,<br>I want you to know<br>How much this moment means to me.</p><br>
    <p>Not because of the place,<br>Not the dinner itself,<br>But because it is shared with you.</p>
    <div class="divider"></div>
    <p style="font-style:italic;opacity:.8">This night is not about perfection,<br>But about presence<br>Shared quietly between us.</p>
    <p style="margin-top:18px;color:var(--gold)">‚Äî Rcs</p>
  </div>
</section>

<section class="page details">
  <div class="card">
    <h2>Dinner Details</h2>
    <div class="divider"></div>
    <p>‚è∞ 17.30 ‚Äì Until the End<br>üìç Picca Steakroom<br>üëó Black Outfit<br>üëü Nike (Couple)</p>
    <a class="map-btn" target="_blank" href="https://maps.app.goo.gl/jSZ6XNFeaouBgtxm6">üìç Open Google Maps</a>   
  </div>
</section>

<section class="page itinerary">
  <div class="card">
    <h2>Event Flow</h2>
    <div class="divider"></div>
    <div class="itinerary-item"><div class="itinerary-time">17.30</div><div class="itinerary-text">Arrival and Warm Welcome</div></div>
    <div class="itinerary-item"><div class="itinerary-time">17.45</div><div class="itinerary-text">Dinner Begins</div></div>
    <div class="itinerary-item"><div class="itinerary-time">18.00</div><div class="itinerary-text">Intimate Conversation</div></div>
    <div class="itinerary-item"><div class="itinerary-time">18.30</div><div class="itinerary-text">Gift Exchange & Suprise</div></div>
    <div class="itinerary-item"><div class="itinerary-time">19.00</div><div class="itinerary-text">Depart From The Venue</div></div>
    <div class="itinerary-item"><div class="itinerary-time">19.30</div><div class="itinerary-text">Photobooth at Blok M</div></div>
    <div class="itinerary-item"><div class="itinerary-time">21.30</div><div class="itinerary-text">Return home</div></div>
  </div>
</section>

<section class="page menu">
  <div class="card">
    <h2>Dinner's Menu</h2>
    <div class="divider"></div>
    <div class="menu-course"><span class="course-title">Appetizer</span><p class="course-desc">Calamari Skewers, Truffle Croquette Mac & Cheese, etc</p></div>
    <div class="menu-course"><span class="course-title">Main Course</span><p class="course-desc">Picanha MB5/MB7 with All you can carbs</p></div>
    <div class="menu-course"><span class="course-title">Pasta</span><p class="course-desc">Aglio E Olio Pasta, Carbonara Pasta, etc</p></div>
    <div class="menu-course"><span class="course-title">Sides</span><p class="course-desc">Ratatouille, Grilled Corn Ribs, etc</p></div>
    <div class="menu-course"><span class="course-title">Dessert</span><p class="course-desc">Classic Tiramisu & Pannacotta</p></div>
    <div class="menu-course"><span class="course-title">Beverage</span><p class="course-desc">Tea, Mineral Water, etc</p></div>
    <div class="menu-course"><span class="course-title">Mocktail</span><p class="course-desc">Cuddle On the Beach, Cham o Chea, etc</p>
      <a class="map-btn" target="_blank" href="https://drive.google.com/file/d/1XatzJRsMNveeErLFS34reQIn9Gvutiuo/view">üçù Open Menu</a>
    </div>
  </div>
</section>

<section class="page closing">
  <div class="card">
    <h2>Closing</h2>
    <div class="divider"></div>
    <p>Touch the heart when the night feels complete.</p>
    <div class="heart" onclick="unlockMoments(event)"></div>
  </div>
</section>

<section class="page moments" id="moments-section">
  <div class="card">
    <h2>Our Memory</h2>
    <div class="divider"></div>
    <div class="moment-grid">
      <div class="moment"><img src="photo1.jpeg" alt="1"></div>
      <div class="moment"><img src="photo2.jpeg" alt="2"></div>
      <div class="moment"><img src="photo3.jpeg" alt="3"></div>
    </div>
    <button id="downloadPhotoStory" class="map-btn">‚ú® Download Photo</button>
  </div>
</section>

<section class="page memory" id="video-section">
  <div class="card">
    <h2>Our Moments</h2>
    <div class="divider"></div>
    <div class="video-wrapper">
      <video id="mainVideo" controls crossorigin="anonymous">
        <source src="video.mp4" type="video/mp4">
      </video>
    </div>
    <button id="downloadVideoStory" class="map-btn">üé¨ Download Video</button>
  </div>
</section>

<div id="story-template" style="position:absolute; left:-9999px; top:0;"> 
  <canvas id="recordCanvas" width="1080" height="1920" style="display:none;"></canvas>
  <div id="story-wrapper" style="width:1080px; height:1920px; background:radial-gradient(circle at top,#1a1a1a,#000); display:flex; flex-direction:column; justify-content:space-between; align-items:center; padding:120px 60px; color:#fff; text-align:center;">
    <div>
      <h1 style="font-size:45px;font-family:'Georgia',serif; color:#d4af6a; font-weight:bold; letter-spacing:8px;margin-top:24px">Our Moment</h1>
      <div style="width:400px;height:2px;background:var(--gold);margin:22px auto;opacity:.6"></div>
    </div>
    
    <div id="story-content-area" style="width:100%; display:flex; justify-content:center; gap:30px; align-items:center;"></div>

    <div style="margin-bottom:80px;">
        <p style="font-size:45px;font-family:'Georgia',serif; color:#d4af6a; font-weight:bold; letter-spacing:8px; margin-top:20px;">25 ¬∑ 12 ¬∑ 2025</p>
        <p style="font-size:22px;font-family:'Georgia',serif; opacity:0.8; margin-top:10px; letter-spacing:5px;">Love, gratitude, and a heart full of grace</p>
        <p style="font-size:22px;font-family:'Georgia',serif; opacity:0.5; margin-top:10px; letter-spacing:5px;">ü©∑</p>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
const INVITATION_PASSWORD="25122025";
const target=new Date("2025-12-25T17:30:00");
const bgmMain=document.getElementById("bgmMain");
const bgmMoments=document.getElementById("bgmMoments");
const icon=document.getElementById("musicIcon");
let currentMusic=null, isPlaying=false;

// Unlock Logic
function unlock(){
  if(document.getElementById("pwd").value===INVITATION_PASSWORD){
    document.getElementById("lock").classList.add("hidden");
    if(!isPlaying){ currentMusic=bgmMain; fadeIn(bgmMain); isPlaying=true; }
  } else { alert("Wrong password!"); }
}

// Observers
const obs=new IntersectionObserver(e=>{e.forEach(x=>x.isIntersecting&&x.target.classList.add("show"))},{threshold:.3});
document.querySelectorAll(".page, .itinerary-item, .menu-course").forEach(p=>obs.observe(p));

// Heart Click -> Show Moments & Video
function unlockMoments(){
  if (new Date() >= target){
    fadeOut(bgmMain); currentMusic=bgmMoments; fadeIn(bgmMoments);
    document.getElementById("moments-section").style.display="flex";
    document.getElementById("video-section").style.display="flex";
    
    document.getElementById("moments-section").scrollIntoView({behavior:"smooth"});
    setTimeout(() => {
        document.querySelectorAll(".moment").forEach((m,idx)=>setTimeout(()=>m.classList.add("show"),idx*200));
        document.getElementById("mainVideo").play();
    }, 500);
  } else { alert("Locked until Dec 25th! ‚ú®"); }
}

// Typing Effect
const text="A special night, made for us."; let i=0;
(function type(){ if(i<text.length){ document.getElementById("typing").textContent+=text[i++]; setTimeout(type,60)}})();

// Countdown
setInterval(()=>{
  const d=target-new Date();
  if(d>0){
    const dd=Math.floor(d/864e5);
    const hh=String(Math.floor(d/36e5)%24).padStart(2,'0');
    const mm=String(Math.floor(d/6e4)%60).padStart(2,'0');
    const ss=String(Math.floor(d/1e3)%60).padStart(2,'0');
    document.getElementById("countdown").textContent=`${dd}D ${hh}H ${mm}M ${ss}S`;
  }
},1000);

function fadeIn(a){ a.volume=0; a.play(); let f=setInterval(()=>{if(a.volume<0.5)a.volume+=0.05;else clearInterval(f)},100)}
function fadeOut(a){ let f=setInterval(()=>{if(a.volume>0.05)a.volume-=0.05;else{a.pause();clearInterval(f)}},100)}

function toggleMusic(){
  if(!isPlaying){ currentMusic.play(); isPlaying=true; icon.textContent="‚ùö‚ùö"; }
  else { currentMusic.pause(); isPlaying=false; icon.textContent="‚ñ∂Ô∏é"; }
}

// ================= GENERATE STORY CANVAS =================
function generateStoryCanvas(filename) {
    const wrapper = document.getElementById('story-wrapper');
    html2canvas(wrapper, { scale: 2, useCORS: true, width: 1080, height: 1920 }).then(canvas => {
        const link = document.createElement('a');
        link.download = filename;
        link.href = canvas.toDataURL();
        link.click();
    });
}

// ================= DOWNLOAD PHOTO STORY (LOGIKA 3 VERTIKAL) =================
document.getElementById('downloadPhotoStory').addEventListener('click', async () => {
    const area = document.getElementById('story-content-area');
    area.innerHTML = "";
    area.style.flexDirection = "column"; // UBAH KE VERTIKAL SAAT DOWNLOAD

    const photos = document.querySelectorAll('.moment img');
    photos.forEach(img => {
        const box = document.createElement('div');
        box.style.cssText = "width:450px; height:450px; border:5px solid #d4af6a; border-radius:20px; overflow:hidden; background:#111;";
        const clone = img.cloneNode();
        clone.style.cssText = "width:100%; height:100%; object-fit:cover;";
        box.appendChild(clone);
        area.appendChild(box);
    });

    generateStoryCanvas("Our Moment.png");
});

// ================= DOWNLOAD VIDEO STORY =================
document.getElementById('downloadVideoStory').addEventListener('click', async () => {
    const video = document.getElementById('mainVideo');
    const canvas = document.getElementById('recordCanvas');
    const ctx = canvas.getContext('2d');
    const btn = document.getElementById('downloadVideoStory');

    // 1. Validasi Audio (Pastikan video sudah di-load)
    if (video.readyState < 2) {
        alert("Video belum siap, silakan tunggu sebentar.");
        return;
    }

    const originalText = btn.textContent;
    btn.textContent = "Processing Audio & Video... üé¨";
    btn.disabled = true;

    // 2. Setup Audio Context untuk menangkap suara
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const source = audioCtx.createMediaElementSource(video);
    const destination = audioCtx.createMediaStreamDestination();
    
    // Sambungkan suara video ke output rekaman DAN ke speaker (agar tetap terdengar saat proses)
    source.connect(destination);
    source.connect(audioCtx.destination);

    // 3. Gabungkan Stream Visual (Canvas) dan Stream Audio
    const canvasStream = canvas.captureStream(30);
    const combinedStream = new MediaStream([
        ...canvasStream.getVideoTracks(),
        ...destination.stream.getAudioTracks()
    ]);

    const recorder = new MediaRecorder(combinedStream, {
        mimeType: 'video/webm;codecs=vp9,opus', // Opus adalah codec audio berkualitas tinggi
        videoBitsPerSecond: 5000000
    });

    const chunks = [];
    recorder.ondataavailable = e => chunks.push(e.data);
    recorder.onstop = () => {
        const blob = new Blob(chunks, { type: 'video/mp4' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "Our_Moment_With_Sound.mp4";
        a.click();
        
        btn.textContent = originalText;
        btn.disabled = false;
        audioCtx.close(); // Tutup audio context setelah selesai
    };

    // 4. Fungsi Draw (Sama seperti sebelumnya)
    function drawFrame() {
        if (video.paused || video.ended) return;

        // Background & Wrapper
        ctx.fillStyle = "#0b0b0b"; 
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Bingkai Luar
        ctx.strokeStyle = "#d4af6a";
        ctx.lineWidth = 15;
        ctx.strokeRect(40, 40, canvas.width - 80, canvas.height - 80);

        // Header Text
        ctx.fillStyle = "#d4af6a";
        ctx.font = "bold 50px Georgia";
        ctx.textAlign = "center";
        ctx.fillText("Our Moment", canvas.width / 2, 250);

        // Frame Video
        const vWidth = 900;
        const vHeight = (video.videoHeight / video.videoWidth) * vWidth;
        const vX = (canvas.width - vWidth) / 2;
        const vY = (canvas.height - vHeight) / 2;
        
        ctx.drawImage(video, vX, vY, vWidth, vHeight);
        ctx.strokeStyle = "#d4af6a";
        ctx.lineWidth = 4;
        ctx.strokeRect(vX, vY, vWidth, vHeight);

        // Footer Text
        ctx.fillStyle = "#d4af6a";
        ctx.font = "bold 45px Georgia";
        ctx.fillText("25 ¬∑ 12 ¬∑ 2025", canvas.width / 2, canvas.height - 250);

        requestAnimationFrame(drawFrame);
    }

    // 5. Mulai Rekam
    video.currentTime = 0;
    video.muted = false; // Jangan di-mute agar audionya bisa ditangkap stream
    video.volume = 1.0;

    // Aktifkan AudioContext (diperlukan oleh kebijakan browser)
    if (audioCtx.state === 'suspended') {
        await audioCtx.resume();
    }

    video.play().then(() => {
        recorder.start();
        drawFrame();
    });

    video.onended = () => {
        recorder.stop();
    };
});
</script>
</body>
</html>
